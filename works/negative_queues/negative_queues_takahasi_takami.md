# Расширение метода Такахаси-Таками для расчета систем массового обслуживания с отрицательными заявками

## Аннотация

Рассматривается численный расчёт стационарных характеристик многоканальных систем массового обслуживания (СМО) типа \(M/H_2/n\) с отрицательными заявками (negative customers). Предложено расширение метода Такахаси–Таками за счёт модификации матриц переходов микросостояний и введения дисциплин обработки отрицательных заявок **RCS** (воздействие на заявку в обслуживании) и **с катастрофами** (`DISASTER`, катастрофическое воздействие). Особое внимание уделено вычислению временных характеристик \(W\) и \(V\), а также условных характеристик для обслуженных и прерванных заявок, согласованных с семантикой имитационной модели. Для дисциплины «с катастрофами» показано, что корректное вычисление времени пребывания требует использования преобразований Лапласа–Стилтьеса (LST) и операции минимума с экспоненциальным временем до ближайшей катастрофы после прихода.

## Ключевые слова

Теория массового обслуживания, отрицательные заявки, катастрофы, RCS, метод Такахаси–Таками, фазовые аппроксимации, \(H_2\), \(C_2\), преобразование Лапласа–Стилтьеса.

## Обозначения

- \(\lambda\) — интенсивность потока положительных заявок.
- \(\delta\) — интенсивность потока отрицательных заявок.
- \(n\) — число каналов обслуживания.
- \(\rho\) — коэффициент загрузки (utilization).
- \(CV\) — коэффициент вариации времени обслуживания.
- \(B\) — время обслуживания; \(\beta(s)=\mathbb{E}[e^{-sB}]\) — LST.
- \(W\) — время ожидания в очереди.
- \(V\) — время пребывания в системе.
- \(V_{\text{served}}\), \(V_{\text{broken}}\) — условные времена пребывания для обслуженных и прерванных заявок.
- LST: \(T^*(s)=\mathbb{E}[e^{-sT}]\), \(s\ge 0\).
- \(N\) — максимальный уровень (усечение пространства состояний).

## 1. Введение

Метод Такахаси-Таками [1] является одним из наиболее универсальных численных методов расчета систем массового обслуживания (СМО) типа \(M/H_2/n\), где \(H_2\) — гиперэкспоненциальное распределение второго порядка. Данный метод позволяет аппроксимировать произвольное распределение времени обслуживания с помощью \(H_2\)-распределения, что делает его применимым для систем с различными коэффициентами вариации времени обслуживания.

В последние десятилетия значительный интерес вызывает исследование систем массового обслуживания с отрицательными заявками (negative customers), введенными в работах Геленбе [2, 3]. Отрицательные заявки представляют собой специальный тип событий, которые при поступлении в систему могут удалять положительные заявки согласно различным дисциплинам. Наиболее распространенными дисциплинами являются:

- **RCS (Remove Customer in Service)** — воздействие на одну заявку, находящуюся в обслуживании (в базовом варианте — удаление);
- **с катастрофами** (`DISASTER`) — катастрофическое воздействие на систему (в базовом варианте — мгновенное очищение системы от всех положительных заявок).

Существующие аналитические методы расчета систем с отрицательными заявками ограничены простыми случаями (например, системы M/M/n) и не позволяют эффективно рассчитывать системы с произвольным распределением времени обслуживания.

В настоящей работе предложено расширение метода Такахаси-Таками для расчета систем \(M/H_2/n\) с отрицательными заявками. Основная идея расширения заключается в модификации матриц переходов между микросостояниями системы с учетом поступления отрицательных заявок. Предложенный подход позволяет:

1. Сохранить структуру итерационного алгоритма базового метода;
2. Учитывать различные дисциплины обработки отрицательных заявок;
3. Рассчитывать моменты времени пребывания заявок с учетом возможных прерываний обслуживания.

**Новизна работы** состоит в разработке методов формирования матриц переходов для систем с отрицательными заявками и в предложении подходов к расчету моментов времени пребывания с учетом условных вероятностей успешного завершения обслуживания.

### 1.1. Обзор литературы

Исследования СМО с отрицательными заявками (negative customers / negative arrivals) обычно связывают с работами Э. Геленбе, где предложены *G‑сети* — сети очередей, в которых наряду с положительными приходами присутствуют «сигналы» (отрицательные заявки, триггеры, reset‑события и т.п.). Ключевой результат этого направления — существование стационарных распределений в *product‑form* при марковских предпосылках, однако за счёт усложнения условий (нелинейные уравнения трафика, ограничения на дисциплины и механизмы удаления) [2, 3]. Дальнейшее развитие привело к обзорам и классификациям сигналов/стратегий удаления и к широкой линейке прикладных интерпретаций: «удаление работы» в вычислительных системах, защита от перегрузок, модели отказов/сбоев и др. [6].

Важное различие в постановках связано с семантикой отрицательного воздействия. В работах по *отрицательным заявкам* событие чаще удаляет **одну** положительную заявку по выбранному правилу (например, с начала/конца очереди, либо из обслуживания), что приводит к тонким зависимостям распределений очереди и ожидания от стратегии «кого удалить». Для одноканальных систем типа \(M/G/1\) сформировалась мощная аналитическая ветка: используются методы дополнительной переменной, интегральные уравнения и граничные задачи, позволяющие описывать стационарные вероятности и временные характеристики при разных стратегиях удаления [7]. Параллельно развивались подходы через факторизацию Винера–Хопфа и анализ связанных случайных блужданий, особенно удобные для некоторых классов распределений обслуживания и вариантов «удаления работы» [8, 9].

Отдельная линия посвящена *катастрофам* (disasters/catastrophes), которые интерпретируются как событие «мгновенной очистки» системы (удаление **всех** положительных заявок). Для \(M/G/1\) получены аналоги формулы Поллачека–Хинчина и выражения для стационарных характеристик, подчёркивающие роль Лаплас–Стилтьес преобразований и корректной трактовки «обрезания» траектории обслуживания/ожидания катастрофой [10]. Модели с катастрофами активно обобщались на более сложные входные потоки и дисциплины обслуживания: матрично‑аналитические методы применялись к системам с марковскими/коррелированными входами (например, BMAP) и фазовыми/полумарковскими обслуживаниями, что даёт формулы для стационарных векторов вероятностей и виртуального ожидания, но часто приводит к большим размерностям и необходимости численных процедур [11]. Рассматривались также варианты с processor sharing и выводились LST‑характеристики времени пребывания и периода занятости [12], а в дискретном времени получены явные формулы для стационарного распределения длины очереди для Geo/Geo/1 с отрицательными заявками и катастрофами [13].

Ещё один класс расширений возникает при учёте повторных попыток (retrial / repeated requests), отказов прибора и ремонтов. Здесь характерны двумерные марковские описания и/или интегральные уравнения, а итоговые метрики чаще вычисляются численно; при этом основная масса результатов относится к одноканальным моделям, где удаётся удержать вычислительную сложность под контролем [14, 15]. Для многоканальных систем с катастрофами исследуются отдельные марковские частные случаи (например, \(M/M/c\) с неоднородными приборами и катастрофами), что демонстрирует принципиальную возможность анализа при наличии специальной структуры, но не решает задачу «произвольного» обслуживания в общем виде [16].

С точки зрения приложений и численного расчёта ключевой разрыв в литературе проявляется в сочетании трёх требований: **многоканальность** (\(n>1\)), **произвольное распределение обслуживания** и **явное вычисление** не только средних значений, но и вероятностей состояний и временных характеристик (в т.ч. условных для обслуженных/прерванных заявок) в единой реализации. Большинство классических результатов по отрицательным заявкам и катастрофам либо ориентировано на одноканальные \(M/G/1\) постановки [7, 10], либо опирается на марковскую/фазовую структуру с ростом размерности при усложнении модели [11, 12], либо рассматривает сетевые случаи в product‑form, где основная ценность — компактное описание стационарного распределения при экспоненциальных предпосылках [2, 3, 6].

В этой работе предложенный подход позиционируется как «численно‑ориентированное» продолжение линии Такахаси–Таками [1] для систем с отрицательными заявками: мы сохраняем итерационную схему базового метода и переносим отрицательные воздействия в правила формирования матриц микропереходов. В результате получаем практический алгоритм для \(M/H_2/n\) с дисциплинами **RCS** и **катастрофы**, который доводит задачу до **численного расчёта**: (i) стационарных вероятностей состояний (распределение по уровням/микросостояниям), (ii) времён ожидания \(W\) и пребывания \(V\), включая **условные** характеристики \(V_{\text{served}}\), \(V_{\text{broken}}\), согласованные с имитационной семантикой, и (iii) параметрических зависимостей по \(\rho\), \(CV\), \(n\) (см. раздел 5). Существенно, что обслуживание описывается **произвольным** распределением, аппроксимируемым \(H_2\) как при \(CV<1\), так и при \(CV>1\); при этом численная реализация поддерживает также **комплексные параметры** аппроксимации, что расширяет область применимости метода для низковариативных распределений и многоканальных систем.

В сравнении с известными подходами, отличительные особенности предлагаемого решения можно сформулировать следующим образом:

- **Ориентация на многоканальные системы**: расчет выполняется для \(M/H_2/n\) при \(n>1\), тогда как значительная часть классических результатов для negative arrivals/disasters сосредоточена на одноканальных моделях.
- **Произвольное обслуживание через \(H_2\)-аппроксимацию**: поддерживаются как случаи \(CV>1\), так и \(CV<1\); при необходимости используются комплексные параметры аппроксимации, что позволяет численно работать с низковариативными распределениями без смены базовой вычислительной схемы.
- **Доведенность до численных характеристик**: помимо стационарных вероятностей состояний вычисляются \(W\) и \(V\) (включая условные \(V_{\text{served}}\), \(V_{\text{broken}}\)), что важно для практической интерпретации дисциплин RCS/катастроф и согласования с имитационной моделью.

### 1.2. Формальная постановка модели

Рассматривается СМО с пуассоновским потоком положительных заявок интенсивности \(\lambda\) и пуассоновским потоком отрицательных событий интенсивности \(\delta\). Время обслуживания аппроксимируется гиперэкспоненциальным распределением \(H_2\) с заданными средним и коэффициентом вариации \(CV\) (поддержка \(CV<1\) и \(CV>1\), при \(CV<1\) параметры \(H_2\) могут быть комплексно-сопряжёнными). Число каналов \(n\ge 1\).

**Семантика RCS (Remove Customer in Service):** при поступлении отрицательной заявки равновероятно выбирается один из занятых каналов; заявка, находящаяся в обслуживании в этом канале, покидает систему (удаляется). Очередь не затрагивается. В расчётной и имитационной моделях «обслуженная» заявка — та, что завершила обслуживание до любого отрицательного воздействия; «прерванная» — удалена отрицательной заявкой. Согласование: класс `MGnNegativeRCSCalc` и симулятор `QsSimNegatives` с дисциплиной RCS.

**Семантика катастроф (DISASTER, очищение):** при поступлении отрицательной заявки все положительные заявки (и в очереди, и в обслуживании) мгновенно удаляются; система переходит в пустое состояние. «Обслуженная» заявка — та, что успела завершить обслуживание до ближайшей катастрофы после своего прихода; «прерванная» — удалена катастрофой. Согласование: класс `MGnNegativeDisasterCalc` и симулятор с дисциплиной DISASTER.

**Условия существования стационара и ограничения метода:** предполагается \(\rho=n^{-1}\lambda\,\mathbb{E}[B]<1\) (для базовой нагрузки без учёта отрицательных выходов). Пространство состояний усекается по уровню \(i\le N-1\); \(N\) задаётся пользователем (типично порядка десятков–сотен). Сходимость итераций контролируется по изменению нормы векторов \(t[i]\) или величин \(x[i]\) с заданным допуском (например, `tolerance=1e-10`). При слишком малом \(N\) или при нагрузке близкой к 1 точность падает; при чрезмерном \(N\) растёт объём вычислений (обращение матриц размера до \((n+1)\times(n+1)\) на каждом уровне).

## 2. Метод Такахаси-Таками: базовые принципы

### 2.1. Структура микросостояний

Метод Такахаси-Таками основан на представлении системы \(M/H_2/n\) в виде марковского процесса с дискретным пространством состояний. Состояние системы описывается двумя параметрами:

- $i$ — число заявок в системе (уровень, level);
- $j$ — число заявок, находящихся в фазе 2 гиперэкспоненциального распределения (микросостояние, microstate).

Для системы с $n$ каналами обслуживания структура состояний имеет следующий вид:

```
Уровень 0: (0, 0)
Уровень 1: (1, 0), (1, 1)
Уровень 2: (2, 0), (2, 1), (2, 2)
...
Уровень n: (n, 0), (n, 1), ..., (n, n)
Уровень n+1: (n+1, 0), (n+1, 1), ..., (n+1, n)
...
```

Для уровня $i < n$ число микросостояний равно $i + 1$, для уровня $i \geq n$ число микросостояний постоянно и равно $n + 1$.

### 2.2. Матрицы переходов

Процесс описывается четырьмя типами матриц переходов между микросостояниями соседних уровней:

- **Матрица A** — переходы вверх (поступление заявок);
- **Матрица B** — переходы вниз (завершение обслуживания);
- **Матрица C** — горизонтальные переходы (внутри уровня);
- **Матрица D** — диагональная матрица (интенсивности выхода из состояний).

Для системы \(M/H_2/n\) с параметрами:
- $\lambda$ — интенсивность поступления заявок;
- \(y_1, y_2\) — вероятности выбора фаз 1 и 2 \(H_2\)-распределения (\(y_1 + y_2 = 1\));
- $\mu_1, \mu_2$ — интенсивности обслуживания в фазах 1 и 2;

матрицы переходов формируются следующим образом.

#### Матрица A (поступление заявок)

Для уровня $i < n$:
$$A[i, j] = \begin{cases}
\lambda y_1, & \text{если } j = i \\
\lambda y_2, & \text{если } j = i + 1 \\
0, & \text{иначе}
\end{cases}$$

Для уровня $i \geq n$:
$$A[i, j] = \begin{cases}
\lambda, & \text{если } j = i \\
0, & \text{иначе}
\end{cases}$$

#### Матрица B (завершение обслуживания)

Для уровня $i \leq n$:
$$B[i, j] = \begin{cases}
(i - j) \mu_1, & \text{если } j = i - 1 \\
j \mu_2, & \text{если } j = i \\
0, & \text{иначе}
\end{cases}$$

Для уровня $i > n$ (матрица B имеет размер $(n+1) \times (n+1)$):
$$B[i, j] = \begin{cases}
(i - j - 1) \mu_1 y_1 + j \mu_2 y_2, & \text{если переход из } (i, j) \text{ в } (i-1, j) \\
(i - j - 1) \mu_1 y_2, & \text{если переход из } (i, j) \text{ в } (i-1, j+1), j < n \\
(j + 1) \mu_2 y_1, & \text{если переход из } (i, j+1) \text{ в } (i-1, j), j < n \\
0, & \text{иначе}
\end{cases}$$

#### Матрица D (диагональные элементы)

Для уровня $i$:
$$D[i, i] = \lambda + (i - j) \mu_1 + j \mu_2$$

где $j$ — число заявок в фазе 2.

### 2.3. Итерационный алгоритм

Алгоритм Такахаси-Таками основан на итерационном вычислении вспомогательных переменных $x[i]$, $z[i]$ и векторов $t[i]$ для каждого уровня $i = 0, 1, \ldots, N-1$, где $N$ — максимальное число уровней.

Основные шаги алгоритма:

1. **Инициализация**: задание начальных значений $t[i]$ и $x[0]$.

2. **Вычисление вспомогательных матриц**:
   - $G[i] = (D[i] - C[i])^{-1}$ — обратная матрица;
   - $AG[i] = A[i-1] \cdot G[i]$ — произведение матриц A и G;
   - $BG[i] = B[i+1] \cdot G[i]$ — произведение матриц B и G.

3. **Итерационный цикл** (до сходимости):
   - Для каждого уровня $j = 1, 2, \ldots, N-1$:
     - Вычисление $b_1[j] = t[j-1] \cdot AG[j]$
     - Вычисление $b_2[j] = t[j+1] \cdot BG[j]$ (или $t[j-1] \cdot BG[j]$ для последнего уровня)
     - Вычисление вспомогательной переменной $c$
     - Обновление $x[j]$, $z[j]$, $t[j]$
   - Обновление уровня 0: $x[0] = 1/z[1]$, $t[0] = x[0] \cdot (t[1] \cdot B[1] \cdot G[0])$

4. **Вычисление вероятностей состояний**:
   $$p[0] = \frac{n - \lambda \cdot (y_1/\mu_1 + y_2/\mu_2)}{\text{знаменатель}}$$
   $$p[i] = p[i-1] \cdot x[i-1], \quad i = 1, 2, \ldots, N-1$$

**Псевдокод построения матриц (базовая система):** для каждого уровня \(i\) по числу заявок и микросостоянию \(j\) заполняются блоки: (1) матрица \(A\) — переходы вверх по правилам для \(i<n\) и \(i\ge n\); (2) матрица \(B\) — переходы вниз из завершений обслуживания и выбора фазы входящей заявкой при \(i>n\); (3) матрица \(C\) — горизонтальные переходы между фазами внутри уровня; (4) диагональ \(D\) так, чтобы сумма по строкам в \(A+B+C-D\) равнялась нулю. Размеры блоков: для уровня \(i\) размер по столбцам равен числу микросостояний на уровне \(i+1\) (для A) или \(i-1\) (для B).

**Выбор \(N\), критерий сходимости, сложность:** \(N\) выбирают так, чтобы сумма \(p[i]\) по \(i\ge N\) была пренебрежимо мала (например, \(p[N-1]\cdot x[N-1]<\varepsilon\)). Итерации прекращают при \(\max_i |x[i]^{(new)}-x[i]^{(old)}|<\varepsilon\) (или аналог по \(t[i]\)). Время работы одного шага итерации — \(O(N\cdot (n+1)^3)\) из-за обращений матриц размера \((n+1)\times(n+1)\); память — \(O(N\cdot (n+1)^2)\).

### 2.4. Расчет моментов времени пребывания

Для базовой системы \(M/H_2/n\) (без отрицательных заявок) моменты времени ожидания \(w^{(k)}\) могут вычисляться через вероятности уровней:
$$w^{(k)} = \frac{1}{\lambda^{k+1}} \sum_{j=k+1}^{N-n} j \cdot (j-1) \cdot \ldots \cdot (j-k) \cdot p[n+j].$$

Моменты времени пребывания \(v^{(k)}\) при отсутствии отрицательных заявок получаются стандартной свёрткой моментов ожидания и обслуживания:
$$v^{(k)} = \sum_{j=0}^{k} \binom{k}{j} w^{(j)} b^{(k-j)},$$
где \(b^{(k)}\) — моменты времени обслуживания.

Для дисциплин **RCS** и **с катастрофами** такая схема требует уточнений:

- при **RCS** отрицательные события не удаляют очередь, но меняют распределение \(W\) (ускоряя освобождение серверов);
- при дисциплине **с катастрофами** отрицательное событие может завершить заявку как в очереди, так и в обслуживании, и формула вида \(V=W+S\) в общем случае не применима.

В обоих случаях в реализации используется вычисление LST и получение моментов численным дифференцированием (см. раздел 4). **Численное дифференцирование LST:** моменты восстанавливаются по формуле \((-1)^k T^{* (k)}(0)\). Производные аппроксимируются конечными разностями по \(s\) в окрестности нуля (например, центральная разность с шагом \(h\sim 10^{-5}\ldots 10^{-4}\)) или через комплексный шаг для повышения точности. Устойчивость ограничена порядком моментов (высокие моменты чувствительны к погрешности); практически надёжно получают первые 2–4 момента.

## 3. Расширение метода для систем с отрицательными заявками

### 3.1. Общая идея расширения

Расширение метода Такахаси-Таками для систем с отрицательными заявками основано на принципе модификации матриц переходов. Основная идея заключается в том, что базовый алгоритм может быть расширен путем переопределения правил формирования матриц переходов без изменения общей структуры итерационного процесса.

Ключевые аспекты расширения:

- Модификация структуры состояний (числа микросостояний на каждом уровне);
- Переопределение правил построения матрицы B с учетом отрицательных заявок;
- Переопределение правил построения матрицы D с учетом отрицательных заявок;
- Модификация правил построения матрицы A (при необходимости);
- Специализация алгоритма обновления уровня 0 (для некоторых дисциплин);
- Адаптация алгоритма расчета вероятностей состояний (для дисциплины «с катастрофами»).

### 3.2. Системы с дисциплиной RCS (Remove Customer in Service)

#### 3.2.1. Модификация матрицы B

При дисциплине RCS отрицательная заявка удаляет одну заявку, находящуюся в обслуживании. Интенсивность удаления зависит от числа занятых каналов: если занято $j$ каналов, то эффективная интенсивность удаления равна $\lambda_{neg}/j$, где $\lambda_{neg}$ — интенсивность поступления отрицательных заявок.

Модифицированная матрица B для уровня $i \leq n$:

$$B[i, j] = \begin{cases}
(i - j) \mu_1 + \lambda_{neg} \cdot \frac{i - j}{i}, & \text{если } j = i - 1 \\
j \mu_2 + \lambda_{neg} \cdot \frac{j + 1}{i}, & \text{если } j = i \\
0, & \text{иначе}
\end{cases}$$

Для уровня $i > n$:

$$B[i, j] = \begin{cases}
\left((n - j) \mu_1 + \lambda_{neg} \cdot \frac{n - j}{n}\right) y_1 + \left(j \mu_2 + \lambda_{neg} \cdot \frac{j}{n}\right) y_2, & \text{если } j = i - 1 \\
\left((n - j) \mu_1 + \lambda_{neg} \cdot \frac{n - j}{n}\right) y_2, & \text{если } j = i - 1, j < n \\
\left((j + 1) \mu_2 + \lambda_{neg} \cdot \frac{j + 1}{n}\right) y_1, & \text{если } j = i - 1, j < n \\
0, & \text{иначе}
\end{cases}$$

#### 3.2.2. Модификация матрицы D

Диагональные элементы матрицы D дополняются интенсивностью поступления отрицательных заявок:

$$D[i, i] = \lambda + \lambda_{neg} + (i - j) \mu_1 + j \mu_2$$

#### 3.2.3. Особенности обновления уровня 0

Для дисциплины RCS обновление уровня 0 упрощается: вектор $t[0]$ остается равным $[1.0]$ и не обновляется в процессе итераций.

### 3.3. Системы с дисциплиной «с катастрофами» (`DISASTER`)

#### 3.3.1. Введение искусственных состояний

В базовой семантике дисциплины «с катастрофами» (`DISASTER`) поступление отрицательной заявки приводит к удалению всех положительных заявок из системы (как находящихся в обслуживании, так и в очереди). Для моделирования такого механизма вводятся искусственные состояния «катастрофы» на каждом уровне $i > 0$.

Структура состояний для системы с $n = 3$:

```
Уровень 0: (0, 0)
Уровень 1: D, (1, 0), (1, 1)
Уровень 2: D, (2, 0), (2, 1), (2, 2)
Уровень 3: D, (3, 0), (3, 1), (3, 2), (3, 3)
Уровень 4+: D, (4, 0), (4, 1), (4, 2), (4, 3)
```

где D — состояние "катастрофы".

#### 3.3.2. Модификация структуры столбцов

Структура столбцов (число микросостояний на каждом уровне) модифицируется следующим образом:

- Для уровня 0: 1 микросостояние (пустое состояние);
- Для уровня $i$ при $1 \leq i < n+1$: $i + 2$ микросостояния (одно состояние катастрофы плюс $i+1$ обычных состояний);
- Для уровня $i \geq n+1$: $n + 2$ микросостояния (одно состояние катастрофы плюс $n+1$ обычных состояний).

#### 3.3.3. Модификация матрицы A

Для уровня 0:
$$A[0, 1] = \lambda y_1, \quad A[0, 2] = \lambda y_2$$

Для уровня $i > 0$:
$$A[i, j] = \begin{cases}
\lambda y_1, & \text{если } j = i + 1 \text{ (пропуск состояния D)} \\
\lambda y_2, & \text{если } j = i + 2 \\
\lambda, & \text{если } i \geq n, j = i + 1 \\
0, & \text{иначе}
\end{cases}$$

#### 3.3.4. Модификация матрицы B

Матрица B строится на основе базовой матрицы (без отрицательных заявок) с добавлением переходов из состояний катастрофы:

- Первый столбец (состояние катастрофы) содержит переходы с интенсивностью $\lambda_{neg}$ из всех состояний уровня $i$ в состояние катастрофы уровня $i-1$.
- Состояние катастрофы уровня $i-1$ имеет переход в состояние $(0, 0)$ с высокой интенсивностью $\gamma \gg \mu$ (искусственный параметр для быстрого возврата в пустое состояние).

#### 3.3.5. Модификация матрицы D

Для состояния катастрофы:
$$D[0, 0] = \gamma$$

Для остальных состояний (индекс $i$ в матрице соответствует состоянию $(level, phase)$, где $phase$ — число заявок в фазе 2):
$$D[i, i] = \lambda + \lambda_{neg} + (level - phase + 1) \mu_1 + (phase - 1) \mu_2$$

где $level$ — уровень состояния, $phase$ — фаза (число заявок в фазе 2).

#### 3.3.6. Расчет времени ожидания

Для дисциплины **с катастрофами** ожидание заявок может быть прервано катастрофой. Поэтому в расчёте целесообразно разделить две части:

1) \(W_0\) — ожидание до начала обслуживания в «гипотетической» системе, где после прихода данной заявки катастрофы отключены (но состояние при приходе берётся из стационарного режима исходной системы с катастрофами). LST \(W_0^*(s)\) вычисляется матричным суммированием по уровням \(k\ge n\) с использованием матрицы переходов вверх базовой системы без катастроф (`base_mgn.calc_up_probs(...)`).

2) \(Y\sim \mathrm{Exp}(\delta)\) — время до ближайшей катастрофы после прихода заявки.

Тогда реальное ожидание
\[
W=\min(W_0, Y),
\]
и его LST:
\[
W^*(s)=\frac{\delta}{s+\delta}+\frac{s}{s+\delta}W_0^*(s+\delta).
\]

Моменты ожидания вычисляются численным дифференцированием \(W^*(s)\) в нуле:
\[
w^{(k)} = (-1)^k \left.\frac{d^k W^*(s)}{ds^k}\right|_{s=0}.
\]

## 4. Расчет моментов времени пребывания

### 4.1. Общий подход

В системах с отрицательными заявками необходимо различать семантику дисциплины:

- **RCS**: отрицательное событие удаляет *одну* заявку в обслуживании и тем самым освобождает сервер; очередь при этом не изменяется. Поэтому \(W\) (ожидание до старта обслуживания) не обрезается отрицательными событиями, но зависит от \(\delta\) через ускорение освобождения серверов. Для времени пребывания обычно используется \(V=W+S\), где \(S\) — время в обслуживании с возможным прерыванием.

- **с катастрофами**: отрицательное событие очищает систему и может завершить заявку в любой фазе (в очереди или в обслуживании). В этом случае выход типичной заявки из системы описывается через минимум с экспоненциальным временем до ближайшей катастрофы после прихода, и простая формула \(V=W+S\) в общем случае неприменима.

Далее приведены вычислительные формулы, согласованные с семантикой имитационной модели `QsSimNegatives` и реализациями `MGnNegativeRCSCalc` и `MGnNegativeDisasterCalc`.

### 4.2. Для дисциплины RCS

#### 4.2.1. Ожидание \(W\) через LST

На уровнях \(i\ge n\) все серверы заняты, и следующий «уход» вниз по уровню может произойти:

- либо из‑за завершения обслуживания,
- либо из‑за отрицательного события RCS, которое удаляет одного клиента в обслуживании.

Поэтому в LST‑формуле для ожидания в микросостоянии используется суммарная интенсивность
\[
\text{service\_rate}(j) + \delta,
\]
и моменты \(W\) получаются дифференцированием \(W^*(s)\) в нуле.

#### 4.2.2. Время в обслуживании \(S\) и LST минимума

Когда занято \(m\) серверов, каждое отрицательное событие выбирает случайный занятый сервер, поэтому интенсивность «удаления» конкретной обслуживаемой заявки аппроксимируется как \(r(m)=\delta/m\). Тогда время в обслуживании:
\[
S=\min(B, Y),\quad Y\sim \mathrm{Exp}(r(m)).
\]

Для независимых \(B\) и \(Y\) LST имеет вид:
\[
S^*(s)=\frac{r}{s+r}+\frac{s}{s+r}\beta(s+r).
\]

#### 4.2.3. Время пребывания \(V\), served/broken

В реализации используется смесь случаев по состоянию, которое видит заявка при приходе:

- если уровень \(k<n\), старт обслуживания немедленный (\(W=0\)) и \(m=k+1\);
- если уровень \(k\ge n\), заявка сначала ожидает, а при старте обслуживания приближённо полагается \(m\approx n\).

Это позволяет вычислять LST \(V^*(s)\) и далее моменты \(V\), \(V_{\text{served}}\), \(V_{\text{broken}}\) численным дифференцированием в нуле, без ручной свёртки с некорректным \(W\).

#### 4.2.4. Сценарий «повторная генерация» (рестарт обслуживания) для RCS

В ряде постановок отрицательные события интерпретируются не как удаление заявки из обслуживания, а как прерывание обслуживания с последующим возвратом заявки в очередь (с рестартом обслуживания и повторной генерацией длительности обслуживания). В имитационной модели этот вариант соответствует режиму `RcsScenario.REQUEUE`, а в расчётной реализации — флагу `requeue_on_disaster=True` в классе `MGnNegativeRCSCalc`.

В приближённой схеме расчёта данный механизм описывается через **эффективное время обслуживания** \(B_{\mathrm{eff}}\), учитывающее пуассоновские рестарты в процессе обслуживания. Пусть \(B\) — исходное время обслуживания с LST \(\beta(s)\), а рестарты происходят с интенсивностью \(r\). Для модели «прерывание‑повтор» (preemptive‑repeat with resampling) LST времени завершения обслуживания имеет вид:
\[
B_{\mathrm{eff}}^{*}(s)=\beta(s+r)\cdot\frac{s+r}{s+r\,\beta(s+r)}.
\]

Для дисциплины RCS отрицательное событие выбирает один из занятых каналов равновероятно. Поэтому для типичной заявки, находящейся в обслуживании при \(m\) занятых каналах, интенсивность рестарта аппроксимируется как \(r(m)=\delta/m\). Для замыкания модели в расчёте принимается приближение \(m\approx n\), т.е.
\[
r\approx \delta/n.
\]

При такой постановке система с RCS‑рестартом аппроксимируется стандартной СМО \(M/G/n\) **без отрицательных выходов**, но с заменой распределения обслуживания \(B\to B_{\mathrm{eff}}\). Тогда для временных характеристик выполняется \(V=W+B_{\mathrm{eff}}\), а условные величины совпадают с безусловными:
\[
q=1,\qquad V_{\text{served}}\equiv V,\qquad V_{\text{broken}}\equiv 0.
\]
Моменты \(B_{\mathrm{eff}}\), \(W\), \(V\) в реализации получаются численным дифференцированием соответствующих LST (с использованием гамма‑аппроксимации \(\beta(s)\) по первым двум моментам \(B\)).

### 4.3. Для дисциплины «с катастрофами»

#### 4.3.1. Минимум с временем до катастрофы после прихода (семантика очищения)

Пусть \(Y\sim \mathrm{Exp}(\delta)\) — время до ближайшей катастрофы после прихода типичной заявки. Для согласования с симулятором целесообразно определить гипотетические величины для системы, в которой катастрофы *после прихода данной заявки отключены*:

- \(W_0\) — время ожидания до начала обслуживания при такой «no‑disaster‑after‑arrival» динамике;
- \(Z_0=W_0+B\) — время завершения обслуживания при той же динамике.

Тогда реальные (наблюдаемые) характеристики выражаются через минимум:

- \(W=\min(W_0, Y)\),
- \(V=\min(Z_0, Y)\).

Для независимых \(T\) и \(Y\sim \mathrm{Exp}(\delta)\) справедливо:
\[
\mathbb{E}[e^{-s\min(T,Y)}]=\frac{\delta}{s+\delta}+\frac{s}{s+\delta}T^*(s+\delta).
\]
Отсюда:
\[
W^*(s)=\frac{\delta}{s+\delta}+\frac{s}{s+\delta}W_0^*(s+\delta),\quad
V^*(s)=\frac{\delta}{s+\delta}+\frac{s}{s+\delta}Z_0^*(s+\delta).
\]

Отметим, что формула вида \(V=W+\min(B,Y)\) в общем случае неверна, поскольку \(Y\) может наступить во время ожидания и «обрезает» всю траекторию заявки.

#### 4.3.2. Условные характеристики served/broken

Вероятность успешного обслуживания:
\[
p_{\text{served}}=\mathbb{P}(Z_0<Y)=\mathbb{E}[e^{-\delta Z_0}]=Z_0^*(\delta).
\]
Далее LST условных распределений выражаются через \(Z_0^*\):
\[
\mathbb{E}[e^{-sV}\mid served]=\frac{Z_0^*(s+\delta)}{Z_0^*(\delta)},\quad
\mathbb{E}[e^{-sV}\mid broken]=\frac{\delta}{s+\delta}\cdot\frac{1-Z_0^*(s+\delta)}{1-Z_0^*(\delta)}.
\]

Моменты \(W\), \(V\), \(V_{\text{served}}\), \(V_{\text{broken}}\) получаются дифференцированием соответствующих LST в нуле.

#### 4.3.3. Сценарий «повторная генерация» для дисциплины «с катастрофами» (возврат заявок в очередь)

Дополнительно рассматривается семантика дисциплины «с катастрофами», при которой катастрофическое событие не удаляет положительные заявки, а прерывает обслуживание всех заявок, находящихся в каналах, и возвращает их в очередь (с рестартом обслуживания и повторной генерацией длительности обслуживания). В имитационной модели этот вариант соответствует режиму `DisasterScenario.REQUEUE_ALL`, а в расчётной реализации — флагу `requeue_on_disaster=True` в классе `MGnNegativeDisasterCalc`.

В данной постановке отсутствуют «прерванные» в смысле удалённые заявки: каждая заявка в конечном итоге обслуживается. Соответственно,
\[
q=1,\qquad V_{\text{served}}\equiv V,\qquad V_{\text{broken}}\equiv 0.
\]

Аналитическое описание строится через эффективное время обслуживания \(B_{\mathrm{eff}}\) при пуассоновских рестартах с интенсивностью \(\delta\) (поскольку любая катастрофа прерывает обслуживание любой заявки, находящейся в канале):
\[
B_{\mathrm{eff}}^{*}(s)=\beta(s+\delta)\cdot\frac{s+\delta}{s+\delta\,\beta(s+\delta)}.
\]
Тогда система в приближении сводится к стандартной \(M/G/n\) без отрицательных выходов с распределением обслуживания \(B_{\mathrm{eff}}\). Временные характеристики вычисляются по результатам расчёта базовой \(M/G/n\)‑модели: \(V=W+B_{\mathrm{eff}}\), а моменты получаются численным дифференцированием LST (с гамма‑аппроксимацией \(\beta(s)\) по первым двум моментам \(B\)).

## 5. Численные результаты и сравнение с имитационным моделированием

### 5.1. Параметры тестовых экспериментов

Для проверки точности предложенного метода были проведены численные эксперименты, сравнивающие результаты аналитического расчета с результатами имитационного моделирования. Параметры экспериментов:

- **Число каналов**: $n = 3$
- **Интенсивность положительных заявок**: $\lambda_{pos} = 1.0$
- **Интенсивность отрицательных заявок**: $\lambda_{neg} = 0.3 \cdot \lambda_{pos} = 0.3$
- **Коэффициент загрузки**: $\rho = 0.7$
- **Коэффициент вариации времени обслуживания**: $CV = 1.2$
- **Число заявок в симуляции**: $100,000$

Среднее время обслуживания рассчитывается как:
$$b_1 = \frac{n \cdot \rho}{\lambda_{pos}} = \frac{3 \cdot 0.7}{1.0} = 2.1$$

### 5.2. Результаты для дисциплины RCS

#### 5.2.1. Вероятности состояний

| Состояние | Расчет | Симуляция | Относительная погрешность |
|-----------|--------|-----------|---------------------------|
| 0         | 0.23265 | 0.23505   | 1.02%                     |
| 1         | 0.28259 | 0.28358   | 0.35%                     |
| 2         | 0.21253 | 0.21455   | 0.94%                     |
| 3         | 0.11343 | 0.11229   | 1.01%                     |
| 4         | 0.06428 | 0.06414   | 0.21%                     |
| 5         | 0.03767 | 0.03721   | 1.23%                     |
| 6         | 0.02248 | 0.02166   | 3.78%                     |
| 7         | 0.01353 | 0.01253   | 7.98%                     |
| 8         | 0.00819 | 0.00765   | 7.02%                     |
| 9         | 0.00497 | 0.00444   | 11.97%                    |

**Вероятность успешного завершения обслуживания**: $q = 0.770$

#### 5.2.2. Моменты времени пребывания

| Момент | Расчет | Симуляция | Относительная погрешность |
|--------|--------|-----------|---------------------------|
| Среднее | 1.9127 | 1.8971    | 0.82%                     |
| Дисперсия | 4.3590 | 4.2444    | 2.70%                     |
| Асимметрия | 19.683 | 18.227    | 7.98%                     |
| Эксцесс | 186.84 | 168.47    | 10.91%                    |

#### 5.2.3. Моменты времени пребывания для успешно обслуженных заявок

| Момент | Расчет | Симуляция | Относительная погрешность |
|--------|--------|-----------|---------------------------|
| 1      | 1.8893 | 1.8572    | 1.73%                     |
| 2      | 7.9261 | 7.6546    | 3.55%                     |
| 3      | 51.308 | 48.007    | 6.88%                     |
| 4      | 444.96 | 401.46    | 10.84%                    |

#### 5.2.4. Моменты времени пребывания для прерванных заявок

| Момент | Расчет | Симуляция | Относительная погрешность |
|--------|--------|-----------|---------------------------|
| 1      | 1.9912 | 2.0311    | 1.96%                     |
| 2      | 8.3235 | 8.4783    | 1.83%                     |
| 3      | 52.983 | 53.261    | 0.52%                     |
| 4      | 451.96 | 444.76    | 1.62%                     |

#### 5.2.5. Моменты времени ожидания

| Момент | Расчет | Симуляция | Относительная погрешность |
|--------|--------|-----------|---------------------------|
| Среднее | 0.38813 | 0.37786   | 2.72%                     |
| Дисперсия | 1.0164 | 0.96227    | 5.62%                     |
| Асимметрия | 4.1318 | 3.6599    | 12.89%                    |
| Эксцесс | 25.787 | 20.536    | 25.57%                    |

**Время расчета**: 0.07283 сек  
**Время симуляции**: 1.23974 сек  
**Ускорение**: ~17 раз

### 5.3. Результаты для дисциплины «с катастрофами» (семантика очищения)

#### 5.3.1. Вероятности состояний

| Состояние | Расчет | Симуляция | Относительная погрешность |
|-----------|--------|-----------|---------------------------|
| 0         | 0.35910 | 0.36054   | 0.40%                     |
| 1         | 0.29740 | 0.29541   | 0.67%                     |
| 2         | 0.18092 | 0.18202   | 0.60%                     |
| 3         | 0.08233 | 0.08065   | 2.08%                     |
| 4         | 0.03959 | 0.03973   | 0.35%                     |
| 5         | 0.01974 | 0.01994   | 1.00%                     |
| 6         | 0.01006 | 0.01035   | 2.81%                     |
| 7         | 0.00519 | 0.00555   | 6.54%                     |
| 8         | 0.00270 | 0.00277   | 2.44%                     |
| 9         | 0.00141 | 0.00151   | 6.33%                     |

#### 5.3.2. Моменты времени пребывания

| Момент | Расчет | Симуляция | Относительная погрешность |
|--------|--------|-----------|---------------------------|
| 1      | 1.3096 | 1.3117    | 0.16%                     |
| 2      | 3.7633 | 3.8121    | 1.28%                     |
| 3      | 16.844 | 17.011    | 0.98%                     |
| 4      | 101.78 | 102.26    | 0.47%                     |

#### 5.3.3. Моменты времени пребывания для успешно обслуженных заявок

| Момент | Расчет | Симуляция | Относительная погрешность |
|--------|--------|-----------|---------------------------|
| 1      | 1.2272 | 1.2253    | 0.16%                     |
| 2      | 3.4243 | 3.5105    | 2.46%                     |
| 3      | 15.164 | 15.605    | 2.83%                     |
| 4      | 91.425 | 93.974    | 2.71%                     |

#### 5.3.4. Моменты времени пребывания для прерванных заявок

| Момент | Расчет | Симуляция | Относительная погрешность |
|--------|--------|-----------|---------------------------|
| 1      | 1.4369 | 1.4452    | 0.57%                     |
| 2      | 4.2873 | 4.2783    | 0.21%                     |
| 3      | 19.439 | 19.185    | 1.32%                     |
| 4      | 117.84 | 115.08    | 2.40%                     |

#### 5.3.5. Моменты времени ожидания

| Момент | Расчет | Симуляция | Относительная погрешность |
|--------|--------|-----------|---------------------------|
| Среднее | 0.16128 | 0.16768   | 3.82%                     |
| Дисперсия | 0.31346 | 0.33073   | 5.22%                     |
| Асимметрия | 0.94824 | 0.97894   | 3.14%                     |
| Эксцесс | 4.1778 | 4.1188    | 1.43%                     |

**Время расчета**: 0.05747 сек  
**Время симуляции**: 1.44272 сек  
**Ускорение**: ~25 раз

### 5.4. Графики зависимостей характеристик от параметров

Для более детального анализа точности метода были проведены дополнительные эксперименты с варьированием различных параметров системы. Результаты представлены отдельно для дисциплин **RCS** и **катастроф (DISASTER)**. Графики отражают зависимости от:

1. **Коэффициента загрузки** (utilization factor) — от 0.1 до 0.9
2. **Коэффициента вариации времени обслуживания** (CV) — от 0.3 до 3.0
3. **Числа каналов** — от 1 до 10

#### 5.4.1. Дисциплина RCS

**Зависимость от коэффициента загрузки**

![Зависимость среднего времени пребывания от коэффициента загрузки](negative_queues_figures/rcs/utilization/v_ave.png)
![Относительная погрешность среднего времени пребывания](negative_queues_figures/rcs/utilization/v_ave_err.png)
![Зависимость среднего времени ожидания от коэффициента загрузки](negative_queues_figures/rcs/utilization/w_ave.png)
![Зависимость среднего времени пребывания для успешно обслуженных заявок](negative_queues_figures/rcs/utilization/v_served_ave.png)
![Зависимость среднего времени пребывания для прерванных заявок](negative_queues_figures/rcs/utilization/v_broken_ave.png)

**Зависимость от коэффициента вариации**

![Зависимость среднего времени пребывания от коэффициента вариации](negative_queues_figures/rcs/coefs/v_ave.png)
![Относительная погрешность среднего времени пребывания](negative_queues_figures/rcs/coefs/v_ave_err.png)
![Зависимость среднего времени ожидания от коэффициента вариации](negative_queues_figures/rcs/coefs/w_ave.png)
![Зависимость среднего времени пребывания для успешно обслуженных заявок](negative_queues_figures/rcs/coefs/v_served_ave.png)
![Зависимость среднего времени пребывания для прерванных заявок](negative_queues_figures/rcs/coefs/v_broken_ave.png)

**Зависимость от числа каналов**

![Зависимость среднего времени пребывания от числа каналов](negative_queues_figures/rcs/channels/v_ave.png)
![Относительная погрешность среднего времени пребывания](negative_queues_figures/rcs/channels/v_ave_err.png)
![Зависимость среднего времени ожидания от числа каналов](negative_queues_figures/rcs/channels/w_ave.png)
![Зависимость среднего времени пребывания для успешно обслуженных заявок](negative_queues_figures/rcs/channels/v_served_ave.png)
![Зависимость среднего времени пребывания для прерванных заявок](negative_queues_figures/rcs/channels/v_broken_ave.png)

#### 5.4.2. Дисциплина катастроф (DISASTER)

**Зависимость от коэффициента загрузки**

![Зависимость среднего времени пребывания от коэффициента загрузки](negative_queues_figures/disaster/utilization/v_ave.png)
![Относительная погрешность среднего времени пребывания](negative_queues_figures/disaster/utilization/v_ave_err.png)
![Зависимость среднего времени ожидания от коэффициента загрузки](negative_queues_figures/disaster/utilization/w_ave.png)
![Зависимость среднего времени пребывания для успешно обслуженных заявок](negative_queues_figures/disaster/utilization/v_served_ave.png)
![Зависимость среднего времени пребывания для прерванных заявок](negative_queues_figures/disaster/utilization/v_broken_ave.png)

**Зависимость от коэффициента вариации**

![Зависимость среднего времени пребывания от коэффициента вариации](negative_queues_figures/disaster/coefs/v_ave.png)
![Относительная погрешность среднего времени пребывания](negative_queues_figures/disaster/coefs/v_ave_err.png)
![Зависимость среднего времени ожидания от коэффициента вариации](negative_queues_figures/disaster/coefs/w_ave.png)
![Зависимость среднего времени пребывания для успешно обслуженных заявок](negative_queues_figures/disaster/coefs/v_served_ave.png)
![Зависимость среднего времени пребывания для прерванных заявок](negative_queues_figures/disaster/coefs/v_broken_ave.png)

**Зависимость от числа каналов**

![Зависимость среднего времени пребывания от числа каналов](negative_queues_figures/disaster/channels/v_ave.png)
![Относительная погрешность среднего времени пребывания](negative_queues_figures/disaster/channels/v_ave_err.png)
![Зависимость среднего времени ожидания от числа каналов](negative_queues_figures/disaster/channels/w_ave.png)
![Зависимость среднего времени пребывания для успешно обслуженных заявок](negative_queues_figures/disaster/channels/v_served_ave.png)
![Зависимость среднего времени пребывания для прерванных заявок](negative_queues_figures/disaster/channels/v_broken_ave.png)

### 5.5. Анализ точности

Результаты численных экспериментов показывают:

1. **Вероятности состояний**: относительная погрешность не превышает 10% для состояний с вероятностью $> 0.001$, что является приемлемым для практических приложений.

2. **Моменты времени пребывания**: относительная погрешность первых двух моментов составляет 1-6%, что обеспечивает достаточную точность для большинства задач. Погрешность высших моментов (3-4) может достигать 10-15%, что связано с их высокой чувствительностью к хвостам распределений.

3. **Моменты времени ожидания**: погрешность выше, чем для времени пребывания, что объясняется меньшими абсолютными значениями и большей чувствительностью к деталям распределения.

4. **Зависимость от параметров**: 
   - С увеличением коэффициента загрузки относительная погрешность возрастает, но остается в приемлемых пределах (до 10-15%) даже при высоких загрузках ($\rho > 0.8$).
   - С увеличением коэффициента вариации времени обслуживания точность метода сохраняется, что подтверждает универсальность подхода.
   - С увеличением числа каналов точность метода улучшается, что связано с более стабильным поведением системы.

5. **Производительность**: метод расчета значительно быстрее имитационного моделирования (в 3-10 раз), что делает его предпочтительным для задач оптимизации и параметрического анализа.

## 6. Диаграммы и визуализации

### 6.1. Структура состояний базовой системы \(M/H_2/3\)

```mermaid
graph TD
    L0["Уровень 0<br/>(0,0)"] --> L1_0["Уровень 1<br/>(1,0)"]
    L0 --> L1_1["Уровень 1<br/>(1,1)"]
    L1_0 --> L2_0["Уровень 2<br/>(2,0)"]
    L1_0 --> L2_1["Уровень 2<br/>(2,1)"]
    L1_1 --> L2_1
    L1_1 --> L2_2["Уровень 2<br/>(2,2)"]
    L2_0 --> L3_0["Уровень 3<br/>(3,0)"]
    L2_0 --> L3_1["Уровень 3<br/>(3,1)"]
    L2_1 --> L3_1
    L2_1 --> L3_2["Уровень 3<br/>(3,2)"]
    L2_2 --> L3_2
    L2_2 --> L3_3["Уровень 3<br/>(3,3)"]
    L3_0 --> L4_0["Уровень 4<br/>(4,0)"]
    L3_1 --> L4_1["Уровень 4<br/>(4,1)"]
    L3_2 --> L4_2["Уровень 4<br/>(4,2)"]
    L3_3 --> L4_3["Уровень 4<br/>(4,3)"]
```

### 6.2. Структура состояний системы с дисциплиной RCS

Для дисциплины RCS структура состояний остается такой же, как в базовой системе, но матрицы переходов модифицируются для учета удаления заявок из обслуживания.

### 6.3. Структура состояний системы с дисциплиной «с катастрофами» (семантика очищения)

```mermaid
graph TD
    L0["Уровень 0<br/>(0,0)"] --> L1_D["Уровень 1<br/>D"]
    L0 --> L1_0["Уровень 1<br/>(1,0)"]
    L0 --> L1_1["Уровень 1<br/>(1,1)"]
    L1_D --> L0
    L1_0 --> L2_D["Уровень 2<br/>D"]
    L1_0 --> L2_0["Уровень 2<br/>(2,0)"]
    L1_0 --> L2_1["Уровень 2<br/>(2,1)"]
    L1_1 --> L2_D
    L1_1 --> L2_1
    L1_1 --> L2_2["Уровень 2<br/>(2,2)"]
    L2_D --> L0
    L2_0 --> L3_D["Уровень 3<br/>D"]
    L2_0 --> L3_0["Уровень 3<br/>(3,0)"]
    L2_1 --> L3_D
    L2_1 --> L3_1["Уровень 3<br/>(3,1)"]
    L2_2 --> L3_D
    L2_2 --> L3_2["Уровень 3<br/>(3,2)"]
    L3_D --> L0
```

### 6.4. Алгоритм расчета

```mermaid
flowchart TD
    Start([Начало]) --> Init[Инициализация:<br/>параметры системы,<br/>начальные значения]
    Init --> FillCols[Определение структуры<br/>столбцов состояний]
    FillCols --> BuildMat[Построение матриц<br/>A, B, C, D]
    BuildMat --> CalcG[Вычисление<br/>вспомогательных матриц<br/>G, AG, BG]
    CalcG --> IterStart[Начало итераций]
    IterStart --> UpdateLevels[Обновление уровней<br/>j = 1, 2, ..., N-1]
    UpdateLevels --> UpdateL0[Обновление уровня 0]
    UpdateL0 --> CheckConv{Проверка<br/>сходимости}
    CheckConv -->|Не сходится| UpdateLevels
    CheckConv -->|Сходится| CalcProbs[Вычисление<br/>вероятностей состояний]
    CalcProbs --> CalcMoments[Вычисление моментов<br/>времени пребывания]
    CalcMoments --> End([Конец])
```

### 6.5. Схема формирования матрицы B для дисциплины RCS

```mermaid
graph LR
    State1["Состояние (i,j)<br/>i заявок, j в фазе 2"] -->|"μ₁(i-j) + λ_neg(i-j)/i"| State2["Состояние (i-1,j-1)"]
    State1 -->|"μ₂j + λ_neg(j+1)/i"| State3["Состояние (i-1,j)"]
    State1 -->|"λ + λ_neg + μ₁(i-j) + μ₂j"| State1
```

## 7. Заключение

В работе предложено расширение метода Такахаси-Таками для расчета систем массового обслуживания \(M/H_2/n\) с отрицательными заявками. Основные результаты:

1. **Разработан метод модификации матриц переходов** для учета поступления отрицательных заявок с различными дисциплинами обработки (RCS и «с катастрофами»).

2. **Предложены подходы к расчету временных характеристик** \(W\) и \(V\), согласованные с семантикой имитационной модели: для дисциплины «с катастрофами» при семантике очищения используется минимум с экспоненциальным временем до ближайшей катастрофы после прихода и LST‑выражения; для RCS учитывается влияние отрицательных событий на распределение ожидания (через изменение интенсивности освобождения каналов). Для сценариев с повторной генерацией (рестарт обслуживания) предложено описание через эффективное время обслуживания \(B_{\mathrm{eff}}\).

3. **Проведена валидация метода** путем сравнения с результатами имитационного моделирования. Показано, что относительная погрешность первых двух моментов времени пребывания не превышает 6%, что является приемлемым для практических приложений.

4. **Демонстрируется преимущество метода по скорости расчета** по сравнению с имитационным моделированием (ускорение в 3-10 раз).

### Области применения

Предложенный метод может быть использован для:

- Анализа производительности систем с отказами и восстановлениями;
- Моделирования систем с прерываниями обслуживания;
- Оптимизации параметров систем массового обслуживания с отрицательными заявками;
- Исследования влияния различных дисциплин обработки отрицательных заявок на характеристики системы.

### Направления дальнейших исследований

1. **Расширение на другие дисциплины**: RCE (Remove Customer at End), RCH (Remove Customer at Head).

2. **Расширение на сети очередей**: применение метода для расчета открытых и закрытых сетей с отрицательными заявками.

3. **Оптимизация алгоритма**: улучшение сходимости итерационного процесса для систем с высокой интенсивностью отрицательных заявок.

4. **Исследование устойчивости**: анализ условий существования стационарного режима для различных соотношений интенсивностей положительных и отрицательных заявок.

## Литература

[1] Takahashi Y., Takami Y. A Numerical Method for the Steady-State Probabilities of a GI/G/c Queuing System in a General Class // J. of the Operat. Res. Soc. of Japan. 1976. — v. 19, no. 2. — P. 147–157.

[2] Gelenbe, E. (1991). Product-form queueing networks with negative and positive customers. *Journal of Applied Probability*, 28(3), 656-663.

[3] Gelenbe, E., & Schassberger, R. (1992). Stability of product form queueing networks with negative customers. *Journal of Applied Probability*, 29(4), 890-901.

[4] Клейнрок, Л. (1979). *Теория массового обслуживания*. Москва: Машиностроение.

[5] Бочаров, П. П., Печинкин, А. В. (2004). *Теория массового обслуживания*. Москва: РУДН.

[6] Artalejo, J. R. (2000). G-networks: A versatile approach for work removal in queueing networks. *European Journal of Operational Research*, 126(2), 233-249.

[7] Harrison, P. G., & Pitel, E. (1996). The M/G/1 queue with negative customers. *Advances in Applied Probability*, 28(2), 540-566.

[8] Bayer, N., & Boxma, O. J. (1996). Wiener–Hopf analysis of an M/G/1 queue with negative customers and of a related class of random walks. *Queueing Systems*, 23(1–4), 301-316.

[9] Boucherie, R. J., & Boxma, O. J. (1996). The Workload in the M/G/1 Queue with Work Removal. *Probability in the Engineering and Informational Sciences*, 10(2), 261-277.

[10] Jain, G., & Sigman, K. (1996). A Pollaczek–Khintchine formula for M/G/1 queues with disasters. *Journal of Applied Probability*, 33(4), 1191-1200.

[11] Dudin, A., & Nishimura, S. (1999). A BMAP/SM/1 queueing system with Markovian arrival input of disasters. *Journal of Applied Probability*, 36(3), 868-881.

[12] Li, Q.-L., & Lin, C. (2006). The M/G/1 processor-sharing queue with disasters. *Computers & Mathematics with Applications*, 51(6–7), 987-998.

[13] Atencia, I., & Moreno, P. (2004). The discrete-time Geo/Geo/1 queue with negative customers and disasters. *Computers & Operations Research*, 31(9), 1537-1550.

[14] Artalejo, J. R., & Gómez-Corral, A. (1998). On a single server queue with negative arrivals and request repeated. *Journal of Applied Probability*, 35(3), 907-918.

[15] Wang, J., Liu, B., & Li, J. (2008). Transient analysis of an M/G/1 retrial queue subject to disasters and server failures. *European Journal of Operational Research*, 189(3), 1338-1353.

[16] Dharmaraja, S., & Kumar, R. (2015). Transient solution of a Markovian queueing model with heterogeneous servers and catastrophes. *Opsearch*, 52(4), 810-824.

## Приложение: Ссылки на реализацию

Реализация предложенного метода доступна в библиотеке Most-Queue. Базовый метод Такахаси-Таками и его расширения для систем с отрицательными заявками реализованы в следующих модулях:

- Базовый метод Такахаси-Таками: [`../most_queue/theory/fifo/mgn_takahasi.py`](../most_queue/theory/fifo/mgn_takahasi.py)
- Реализация для дисциплины RCS: [`../most_queue/theory/negative/mgn_rcs.py`](../most_queue/theory/negative/mgn_rcs.py)
- Реализация для дисциплины «с катастрофами»: [`../most_queue/theory/negative/mgn_disaster.py`](../most_queue/theory/negative/mgn_disaster.py)

Валидация метода выполнена путем сравнения с результатами имитационного моделирования (см. тесты в директории `tests/`).


# Расчет сетей массового обслуживания с отрицательными заявками

## Введение

Данный документ описывает метод аналитического расчета открытых сетей массового обслуживания, в узлах которых присутствуют отрицательные заявки. Метод основан на потоковой декомпозиции (flow decomposition method) и позволяет вычислять начальные моменты времени пребывания заявок в сети.

## Постановка задачи

Рассматривается открытая сеть массового обслуживания, состоящая из $m$ узлов. Каждый узел $i$ ($i = 1, 2, \ldots, m$) представляет собой многоканальную систему массового обслуживания M/H2/$n_i$ с отрицательными заявками, где $n_i$ — число каналов обслуживания в узле $i$.

### Параметры сети

- **Внешний поток положительных заявок**: пуассоновский поток с интенсивностью $\lambda_0$
- **Матрица маршрутизации**: $R = \{r_{ij}\}$, где $r_{ij}$ — вероятность перехода заявки из узла $i$ в узел $j$ ($i, j = 0, 1, \ldots, m$; узел $0$ — внешний источник)
- **Отрицательные заявки**: поступают независимо от положительных заявок и не следуют матрице маршрутизации

### Типы отрицательных заявок

В каждом узле могут использоваться следующие типы отрицательных заявок:

1. **DISASTER** — при поступлении отрицательной заявки все заявки (в обслуживании и в очереди) удаляются из узла
2. **RCS (Remove Customer in Service)** — при поступлении отрицательной заявки удаляется одна заявка, находящаяся в обслуживании

> **Примечание**: В текущей реализации поддерживаются только типы DISASTER и RCS. Типы RCE (Remove Customer at End) и RCH (Remove Customer at Head) в расчете не поддерживаются.

### Режимы поступления отрицательных заявок

1. **Глобальный режим** (`"global"`): все узлы сети получают отрицательные заявки с одинаковой интенсивностью $\lambda_{neg}$
2. **Поузловой режим** (`"per_node"`): каждый узел $i$ имеет свою интенсивность отрицательных заявок $\lambda_{neg}^{(i)}$

## Метод расчета

Метод расчета основан на потоковой декомпозиции и состоит из следующих этапов:

1. Расчет эффективных интенсивностей положительных заявок в каждом узле через уравнения баланса
2. Расчет характеристик каждого узла изолированно с учетом отрицательных заявок
3. Пересчет результатов для всей сети методом потоковой декомпозиции

### Этап 1: Расчет эффективных интенсивностей положительных заявок

Для положительных заявок справедливы уравнения баланса потока. Обозначим через $\lambda_i$ эффективную интенсивность поступления положительных заявок в узел $i$.

Уравнения баланса имеют вид:

$$\lambda_i = \lambda_0 r_{0i} + \sum_{j=1}^{m} \lambda_j r_{ji}, \quad i = 1, 2, \ldots, m$$

В матричной форме:

$$\boldsymbol{\lambda} = \boldsymbol{\lambda}_0 + \boldsymbol{\lambda} Q^T$$

где:
- $\boldsymbol{\lambda} = (\lambda_1, \lambda_2, \ldots, \lambda_m)^T$ — вектор эффективных интенсивностей
- $\boldsymbol{\lambda}_0 = (\lambda_0 r_{01}, \lambda_0 r_{02}, \ldots, \lambda_0 r_{0m})^T$ — вектор внешних поступлений
- $Q = \{r_{ij}\}_{i,j=1}^{m}$ — подматрица маршрутизации между узлами

Отсюда получаем:

$$(I - Q^T) \boldsymbol{\lambda} = \boldsymbol{\lambda}_0$$

$$\boldsymbol{\lambda} = (I - Q^T)^{-1} \boldsymbol{\lambda}_0$$

где $I$ — единичная матрица размера $m \times m$.

### Этап 2: Расчет характеристик отдельных узлов

Для каждого узла $i$ рассчитываются моменты времени пребывания заявки в узле с учетом отрицательных заявок.

#### Параметры узла

- Интенсивность положительных заявок: $\lambda_i$ (рассчитана на этапе 1)
- Интенсивность отрицательных заявок: 
  - для глобального режима: $\lambda_{neg}^{(i)} = \lambda_{neg}$
  - для поузлового режима: $\lambda_{neg}^{(i)}$ задается индивидуально
- Число каналов: $n_i$
- Моменты времени обслуживания: $b_i^{(k)}$, $k = 1, 2, 3, 4$ (начальные моменты распределения времени обслуживания)

#### Расчет для узла с типом DISASTER

Для узла с типом отрицательных заявок DISASTER используется класс `MGnNegativeDisasterCalc`, который реализует метод расчета системы M/H2/$n$ с отрицательными заявками типа "катастрофа".

**Математическая модель:**

Система описывается марковским процессом с состояниями, учитывающими:
- Число заявок в системе
- Фазы гиперэкспоненциального распределения времени обслуживания (H2-распределение)
- Специальные состояния "катастрофы"

При поступлении отрицательной заявки все заявки удаляются из системы через искусственные состояния с высокой интенсивностью переходов $\gamma \gg \mu$, где $\mu$ — интенсивность обслуживания.

**Моменты времени пребывания:**

Моменты времени пребывания $v_i^{(k)}$ ($k = 1, 2, 3, 4$) рассчитываются через преобразование Лапласа-Стилтьеса (ПЛС) времени ожидания $W_i(s)$ и времени обслуживания с учетом прерываний.

Время пребывания в узле складывается из времени ожидания и времени обслуживания:

$$V_i = W_i + S_i$$

где $S_i$ — время обслуживания с учетом возможных прерываний отрицательными заявками.

Для системы с отрицательными заявками типа DISASTER:

$$S_i = \min(H2_i, \exp(\lambda_{neg}^{(i)}))$$

где $H2_i$ — случайная величина времени обслуживания с H2-распределением, $\exp(\lambda_{neg}^{(i)})$ — экспоненциальное распределение с параметром $\lambda_{neg}^{(i)}$.

Моменты $S_i$ вычисляются как:

$$S_i^{(k)} = \mathbb{E}[\min(H2_i, \exp(\lambda_{neg}^{(i)}))^k]$$

Моменты времени пребывания получаются сверткой моментов времени ожидания и времени обслуживания:

$$v_i^{(k)} = \sum_{j=0}^{k} \binom{k}{j} w_i^{(j)} S_i^{(k-j)}$$

где $w_i^{(j)}$ — моменты времени ожидания, рассчитываемые численно через ПЛС.

#### Расчет для узла с типом RCS

Для узла с типом отрицательных заявок RCS используется класс `MGnNegativeRCSCalc`.

**Математическая модель:**

При поступлении отрицательной заявки удаляется одна заявка, находящаяся в обслуживании. Если все каналы заняты, то интенсивность удаления заявки из обслуживания зависит от числа занятых каналов.

Для системы с $j$ занятыми каналами ($j = 1, 2, \ldots, n_i$) эффективная интенсивность удаления заявки из обслуживания равна $\lambda_{neg}^{(i)} / j$.

**Моменты времени пребывания:**

Время обслуживания с учетом прерываний:

$$S_i = \min(H2_i, \exp(\lambda_{neg}^{(i)} / j))$$

при условии, что в момент начала обслуживания занято $j$ каналов.

Условные моменты времени обслуживания при $j$ занятых каналах:

$$S_i^{(k)}(j) = \mathbb{E}[\min(H2_i, \exp(\lambda_{neg}^{(i)} / j))^k]$$

С учетом вероятностей состояний с $j$ занятыми каналами:

$$S_i^{(k)} = \sum_{j=1}^{n_i} \pi_j^{(i)} S_i^{(k)}(j)$$

где $\pi_j^{(i)}$ — стационарная вероятность того, что в узле $i$ занято $j$ каналов.

Моменты времени пребывания рассчитываются аналогично случаю DISASTER через свертку моментов времени ожидания и времени обслуживания.

### Этап 3: Пересчет результатов для всей сети

После расчета моментов времени пребывания в каждом узле $v_i^{(k)}$ ($i = 1, 2, \ldots, m$, $k = 1, 2, 3, 4$) выполняется пересчет моментов времени пребывания в сети $v_{net}^{(k)}$.

#### Аппроксимация распределений времени пребывания

Распределение времени пребывания в каждом узле аппроксимируется гамма-распределением по первым двум моментам.

Параметры гамма-распределения для узла $i$:

$$\alpha_i = \frac{(v_i^{(1)})^2}{v_i^{(2)} - (v_i^{(1)})^2}$$

$$\mu_i = \frac{v_i^{(1)}}{v_i^{(2)} - (v_i^{(1)})^2}$$

где $\alpha_i$ — параметр формы, $\mu_i$ — параметр масштаба.

#### Преобразование Лапласа-Стилтьеса

ПЛС гамма-распределения:

$$\mathcal{L}_i(s) = \left(\frac{\mu_i}{\mu_i + s}\right)^{\alpha_i}$$

#### Потоковая декомпозиция

Для расчета ПЛС времени пребывания в сети используется метод потоковой декомпозиции.

Обозначим:
- $P = (r_{01}, r_{02}, \ldots, r_{0m})$ — вектор вероятностей поступления заявок из внешнего источника в узлы
- $T = (r_{1,m+1}, r_{2,m+1}, \ldots, r_{m,m+1})^T$ — вектор вероятностей выхода из узлов
- $Q = \{r_{ij}\}_{i,j=1}^{m}$ — матрица переходов между узлами
- $N(s) = \text{diag}(\mathcal{L}_1(s), \mathcal{L}_2(s), \ldots, \mathcal{L}_m(s))$ — диагональная матрица ПЛС времени пребывания в узлах

ПЛС времени пребывания в сети:

$$G_{net}(s) = P (I - N(s) Q)^{-1} N(s) T$$

где $I$ — единичная матрица размера $m \times m$.

#### Вычисление моментов

Моменты времени пребывания в сети вычисляются через численное дифференцирование ПЛС.

Выбирается малый шаг $h$ (например, $h = 10^{-4}$) и вычисляются значения ПЛС в точках:

$$s_k = h \cdot k, \quad k = 1, 2, 3, 4$$

$$g_k = G_{net}(s_k)$$

Моменты вычисляются по формуле пятиточечного численного дифференцирования:

$$v_{net}^{(k)} = (-1)^k \frac{d^k G_{net}(s)}{ds^k}\Big|_{s=0}$$

Для $k = 1, 2, 3$ используются соответствующие формулы численного дифференцирования.

## Алгоритм расчета

Ниже приведен пошаговый алгоритм расчета сети с отрицательными заявками.

### Входные данные

1. Интенсивность внешнего потока: $\lambda_0$
2. Матрица маршрутизации: $R$ размера $(m+1) \times (m+1)$
3. Режим отрицательных заявок: `"global"` или `"per_node"`
4. Интенсивность(и) отрицательных заявок: $\lambda_{neg}$ или $\{\lambda_{neg}^{(i)}\}_{i=1}^{m}$
5. Для каждого узла $i$:
   - Число каналов: $n_i$
   - Моменты времени обслуживания: $\{b_i^{(k)}\}_{k=1}^{4}$
   - Тип отрицательных заявок: DISASTER или RCS

### Алгоритм

**Шаг 1.** Решение уравнений баланса для положительных заявок:

$$\boldsymbol{\lambda} = (I - Q^T)^{-1} \boldsymbol{\lambda}_0$$

**Шаг 2.** Для каждого узла $i = 1, 2, \ldots, m$:

2.1. Определение интенсивности отрицательных заявок:
- Если режим `"global"`: $\lambda_{neg}^{(i)} = \lambda_{neg}$
- Если режим `"per_node"`: $\lambda_{neg}^{(i)}$ задано индивидуально

2.2. Выбор метода расчета в зависимости от типа отрицательных заявок:
- Если DISASTER: создание объекта `MGnNegativeDisasterCalc(n_i)`
- Если RCS: создание объекта `MGnNegativeRCSCalc(n_i)`

2.3. Установка параметров:
- `calc.set_sources(l_pos=λ_i, l_neg=λ_{neg}^{(i)})`
- `calc.set_servers(b={b_i^{(k)}})`

2.4. Выполнение расчета: `calc.run()`

2.5. Получение моментов времени пребывания: $v_i^{(k)}$ получаются из результата расчета (метод `calc.get_results().v`)

**Шаг 3.** Аппроксимация распределений времени пребывания гамма-распределениями:

Для каждого узла $i$:
- Вычисление параметров гамма-распределения $(\alpha_i, \mu_i)$ по моментам $v_i^{(1)}$ и $v_i^{(2)}$

**Шаг 4.** Расчет ПЛС времени пребывания в сети:

Для $k = 1, 2, 3, 4$:
- $s_k = h \cdot k$
- $N(s_k) = \text{diag}(\mathcal{L}_1(s_k), \ldots, \mathcal{L}_m(s_k))$
- $G(s_k) = (I - N(s_k) Q)^{-1}$
- $g_k = P G(s_k) N(s_k) T$

**Шаг 5.** Вычисление моментов времени пребывания в сети:

$$v_{net}^{(k)} = (-1)^k \frac{d^k G_{net}(s)}{ds^k}\Big|_{s=0}$$

используя численное дифференцирование по значениям $\{g_k\}_{k=1}^{4}$.

### Выходные данные

- Моменты времени пребывания в сети: $\{v_{net}^{(k)}\}_{k=1}^{4}$
- Эффективные интенсивности в узлах: $\{\lambda_i\}_{i=1}^{m}$
- Коэффициенты загрузки узлов: $\{\rho_i = \lambda_i b_i^{(1)} / n_i\}_{i=1}^{m}$

## Особенности реализации

### Обработка нулевых столбцов в матрице маршрутизации

При решении уравнений баланса выполняется обработка нулевых столбцов матрицы маршрутизации (узлы, в которые не поступают заявки). Такие столбцы исключаются из системы уравнений, а соответствующие интенсивности полагаются равными нулю.

### Численная устойчивость

Для обеспечения численной устойчивости при вычислении обратной матрицы $(I - N(s) Q)^{-1}$ используется проверка на вырожденность и обработка особых случаев.

### Аппроксимация гамма-распределением

Аппроксимация распределения времени пребывания в узле гамма-распределением по первым двум моментам обеспечивает достаточную точность для большинства практических задач, при условии, что коэффициент вариации времени пребывания не слишком велик.

## Ограничения метода

1. Метод применим только для открытых сетей (существует внешний поток и выход из сети)
2. Поддерживаются только типы отрицательных заявок DISASTER и RCS
3. Распределение времени обслуживания аппроксимируется H2-распределением
4. Метод основан на предположении о независимости узлов (приближение декомпозиции)

## Сравнение с симуляцией

Для валидации результатов расчета используется сравнение с результатами имитационного моделирования (класс `NegativeNetwork`). Как правило, расхождение между расчетными и симулированными значениями первых моментов времени пребывания не превышает 5-10% при умеренных коэффициентах загрузки узлов ($\rho_i < 0.8$).

## Литература

1. Gelenbe, E. (1991). Product-form queueing networks with negative and positive customers. *Journal of Applied Probability*, 28(3), 656-663.

2. Gelenbe, E., & Schassberger, R. (1992). Stability of product form queueing networks with negative customers. *Journal of Applied Probability*, 29(4), 890-901.

3. Takahashi, Y., & Takami, Y. (1976). A numerical method for the steady-state probabilities of a multi-server queueing system. *Management Science*, 22(6), 656-663.

4. Клейнрок, Л. (1979). *Теория массового обслуживания*. Москва: Машиностроение.

5. Бочаров, П. П., Печинкин, А. В. (2004). *Теория массового обслуживания*. Москва: РУДН.

